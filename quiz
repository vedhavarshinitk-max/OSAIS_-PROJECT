import gradio as gr
from typing import Dict, List, Tuple, Optional
import random


class QuizBackend:
    
    
    def __init__(self):
        # Question Bank Storage
        self.question_bank = [
            {
                "id": 1,
                "question": "What is the capital of France?",
                "options": ["London", "Berlin", "Paris", "Madrid"],
                "correct_answer": 2,  # Index of correct option
                "category": "Geography"
            },
            {
                "id": 2,
                "question": "Who painted the Mona Lisa?",
                "options": ["Vincent van Gogh", "Leonardo da Vinci", "Pablo Picasso", "Michelangelo"],
                "correct_answer": 1,
                "category": "Art"
            },
            {
                "id": 3,
                "question": "What is the largest planet in our solar system?",
                "options": ["Mars", "Saturn", "Jupiter", "Neptune"],
                "correct_answer": 2,
                "category": "Science"
            },
            {
                "id": 4,
                "question": "In which year did World War II end?",
                "options": ["1943", "1944", "1945", "1946"],
                "correct_answer": 2,
                "category": "History"
            },
            {
                "id": 5,
                "question": "What is the smallest prime number?",
                "options": ["0", "1", "2", "3"],
                "correct_answer": 2,
                "category": "Mathematics"
            },
            {
                "id": 6,
                "question": "Which programming language is known as the 'mother of all languages'?",
                "options": ["Python", "C", "Java", "Assembly"],
                "correct_answer": 1,
                "category": "Technology"
            },
            {
                "id": 7,
                "question": "What is the chemical symbol for gold?",
                "options": ["Go", "Gd", "Au", "Ag"],
                "correct_answer": 2,
                "category": "Science"
            },
            {
                "id": 8,
                "question": "Who wrote 'Romeo and Juliet'?",
                "options": ["Charles Dickens", "William Shakespeare", "Jane Austen", "Mark Twain"],
                "correct_answer": 1,
                "category": "Literature"
            },
            {
                "id": 9,
                "question": "What is the speed of light?",
                "options": ["300,000 km/s", "150,000 km/s", "450,000 km/s", "200,000 km/s"],
                "correct_answer": 0,
                "category": "Physics"
            },
            {
                "id": 10,
                "question": "Which country is home to the kangaroo?",
                "options": ["New Zealand", "Australia", "South Africa", "Brazil"],
                "correct_answer": 1,
                "category": "Geography"
            }
        ]
        
       
        self.current_question_index = 0
        self.score = 0
        self.total_questions = len(self.question_bank)
        self.user_answers = []
        
    def initialize_quiz(self) -> Dict:
        """
        Backend Method: Initialize/Reset quiz state
        Returns: Initial quiz configuration
        """
        self.current_question_index = 0
        self.score = 0
        self.user_answers = []
        random.shuffle(self.question_bank)  # Randomize questions
        
        return {
            "status": "initialized",
            "total_questions": self.total_questions,
            "message": "Quiz initialized successfully"
        }
    
    def get_current_question(self) -> Optional[Dict]:
        """
        Backend Method: Retrieve current question data
        Returns: Question object or None if quiz completed
        """
        if self.current_question_index >= self.total_questions:
            return None
        
        question_data = self.question_bank[self.current_question_index]
        
        return {
            "question_number": self.current_question_index + 1,
            "question_text": question_data["question"],
            "options": question_data["options"],
            "category": question_data["category"],
            "total_questions": self.total_questions
        }
    
    def validate_answer(self, selected_option_index: int) -> Dict:
        """
        Backend Method: Validate submitted answer
        Args: selected_option_index - User's selected option (0-3)
        Returns: Validation result with correctness and feedback
        """
        if self.current_question_index >= self.total_questions:
            return {"error": "Quiz already completed"}
        
        current_q = self.question_bank[self.current_question_index]
        correct_index = current_q["correct_answer"]
        is_correct = (selected_option_index == correct_index)
        
        
        if is_correct:
            self.score += 1
        
        
        self.user_answers.append({
            "question": current_q["question"],
            "selected": selected_option_index,
            "correct": correct_index,
            "is_correct": is_correct
        })
        
        
        response = {
            "is_correct": is_correct,
            "correct_answer": current_q["options"][correct_index],
            "selected_answer": current_q["options"][selected_option_index],
            "explanation": f"The correct answer is: {current_q['options'][correct_index]}",
            "current_score": self.score,
            "questions_answered": self.current_question_index + 1
        }
        
        
        self.current_question_index += 1
        
        return response
    
    def get_final_results(self) -> Dict:
        """
        Backend Method: Calculate and return final quiz results
        Returns: Complete quiz summary with score and performance
        """
        percentage = (self.score / self.total_questions) * 100
        
       
        if percentage >= 90:
            grade = "Excellent! üåü"
        elif percentage >= 70:
            grade = "Great Job! üëç"
        elif percentage >= 50:
            grade = "Good Effort! üìö"
        else:
            grade = "Keep Practicing! üí™"
        
        return {
            "total_questions": self.total_questions,
            "correct_answers": self.score,
            "incorrect_answers": self.total_questions - self.score,
            "percentage": round(percentage, 2),
            "grade": grade,
            "answers_review": self.user_answers
        }
    
    def is_quiz_completed(self) -> bool:
        """
        Backend Method: Check if quiz is completed
        Returns: Boolean indicating completion status
        """
        return self.current_question_index >= self.total_questions


class QuizFrontend:
    """
    Frontend Layer: Handles all UI logic and user interactions
    """
    
    def __init__(self, backend: QuizBackend):
        self.backend = backend  
        self.current_question_data = None
        self.awaiting_next = False
        
    def start_quiz(self) -> Tuple:
        
        init_response = self.backend.initialize_quiz()
        
        
        self.current_question_data = self.backend.get_current_question()
        
        if self.current_question_data:
            question_text = self.current_question_data["question_text"]
            options = self.current_question_data["options"]
            progress = f"Question {self.current_question_data['question_number']}/{self.current_question_data['total_questions']}"
            category = f"üìÇ Category: {self.current_question_data['category']}"
            
            return (
                gr.update(visible=False),  # Hide start screen
                gr.update(visible=True),   # Show quiz screen
                gr.update(visible=False),  # Hide result screen
                question_text,             # Question text
                options[0], options[1], options[2], options[3],  # Options
                "",                        # Clear feedback
                progress,                  # Progress text
                category,                  # Category text
                gr.update(interactive=True, visible=True),  # Enable option buttons
                gr.update(interactive=True, visible=True),
                gr.update(interactive=True, visible=True),
                gr.update(interactive=True, visible=True),
                gr.update(visible=False)   # Hide next button initially
            )
        
        return self._show_error("Failed to load questions")
    
    def submit_answer(self, option_index: int) -> Tuple:
        """
        Frontend Method: Handle answer submission
        Args: option_index - Selected option (0-3)
        Returns: Updated UI with feedback
        """
       
        validation_response = self.backend.validate_answer(option_index)
        
        if "error" in validation_response:
            return self._show_error(validation_response["error"])
        
        
        is_correct = validation_response["is_correct"]
        feedback_msg = "‚úÖ Correct!" if is_correct else "‚ùå Incorrect!"
        feedback_msg += f"\n{validation_response['explanation']}"
        feedback_msg += f"\n\nüìä Score: {validation_response['current_score']}/{validation_response['questions_answered']}"
        
       
        feedback_color = "#28a745" if is_correct else "#dc3545"
        feedback_html = f'<div style="padding: 15px; border-radius: 10px; background-color: {feedback_color}; color: white; font-weight: bold; text-align: center;">{feedback_msg}</div>'
        
        
        return (
            feedback_html,
            gr.update(interactive=False),  # Disable all options
            gr.update(interactive=False),
            gr.update(interactive=False),
            gr.update(interactive=False),
            gr.update(visible=True)  # Show next button
        )
    
    def load_next_question(self) -> Tuple:
        """
        Frontend Method: Load next question or show results
        Returns: Updated UI components
        """
        
        if self.backend.is_quiz_completed():
            return self._show_results()
        
       
        self.current_question_data = self.backend.get_current_question()
        
        if self.current_question_data:
            question_text = self.current_question_data["question_text"]
            options = self.current_question_data["options"]
            progress = f"Question {self.current_question_data['question_number']}/{self.current_question_data['total_questions']}"
            category = f"üìÇ Category: {self.current_question_data['category']}"
            
            return (
                question_text,
                options[0], options[1], options[2], options[3],
                "",  # Clear feedback
                progress,
                category,
                gr.update(interactive=True, visible=True),  # Re-enable options
                gr.update(interactive=True, visible=True),
                gr.update(interactive=True, visible=True),
                gr.update(interactive=True, visible=True),
                gr.update(visible=False)  # Hide next button
            )
        
        return self._show_results()
    
    def _show_results(self) -> Tuple:
        """
        Frontend Method: Display final results screen
        Returns: Result screen UI components
        """
        
        results = self.backend.get_final_results()
        
       
        results_html = f"""
        <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; color: white;">
            <h1 style="font-size: 48px; margin: 0;">üéâ Quiz Completed!</h1>
            <h2 style="font-size: 36px; margin: 20px 0;">{results['grade']}</h2>
            <div style="background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; margin: 20px 0;">
                <p style="font-size: 24px; margin: 10px 0;">üìä Your Score</p>
                <p style="font-size: 48px; font-weight: bold; margin: 10px 0;">{results['correct_answers']}/{results['total_questions']}</p>
                <p style="font-size: 20px; margin: 10px 0;">Accuracy: {results['percentage']}%</p>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px;">
                <div style="background: rgba(40,167,69,0.3); padding: 15px; border-radius: 10px;">
                    <p style="font-size: 18px; margin: 5px 0;">‚úÖ Correct</p>
                    <p style="font-size: 32px; font-weight: bold; margin: 5px 0;">{results['correct_answers']}</p>
                </div>
                <div style="background: rgba(220,53,69,0.3); padding: 15px; border-radius: 10px;">
                    <p style="font-size: 18px; margin: 5px 0;">‚ùå Incorrect</p>
                    <p style="font-size: 32px; font-weight: bold; margin: 5px 0;">{results['incorrect_answers']}</p>
                </div>
            </div>
        </div>
        """
        
        return (
            gr.update(visible=False),  # Hide quiz screen
            gr.update(visible=True),   # Show result screen
            results_html
        )
    
    def restart_quiz(self) -> Tuple:
        """
        Frontend Method: Restart the quiz
        Returns: Reset to start screen
        """
        return (
            gr.update(visible=True),   # Show start screen
            gr.update(visible=False),  # Hide quiz screen
            gr.update(visible=False),  # Hide result screen
            "",                        # Clear all fields
            "", "", "", "",
            "",
            "",
            "",
            gr.update(interactive=True),
            gr.update(interactive=True),
            gr.update(interactive=True),
            gr.update(interactive=True),
            gr.update(visible=False),
            ""
        )
    
    def _show_error(self, error_msg: str) -> Tuple:
        """
        Frontend Method: Display error message
        """
        error_html = f'<div style="padding: 15px; background-color: #dc3545; color: white; border-radius: 10px;">{error_msg}</div>'
        return (error_html,) + tuple([gr.update()] * 12)


def create_quiz_app():
    """
    Main Application: Creates Gradio interface integrating both layers
    """
    
    backend = QuizBackend()
    
   
    frontend = QuizFrontend(backend)
    
    
    with gr.Blocks(theme=gr.themes.Soft(), css="""
        .container { max-width: 800px; margin: auto; }
        .option-btn { font-size: 16px !important; padding: 20px !important; margin: 5px 0 !important; }
    """) as app:
        
        gr.HTML("""
            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; margin-bottom: 20px;">
                <h1 style="color: white; font-size: 42px; margin: 0;">üéØ Quiz Master</h1>
                <p style="color: white; font-size: 18px; margin: 10px 0;">Test Your General Knowledge</p>
            </div>
        """)
        
        
        with gr.Column(visible=True) as start_screen:
            gr.HTML("""
                <div style="text-align: center; padding: 40px;">
                    <h2 style="font-size: 32px; color: #667eea;">üì± Welcome to Quiz Master!</h2>
                    <p style="font-size: 18px; color: #666; margin: 20px 0;">
                        Test your knowledge across multiple categories including:<br>
                        üåç Geography | üé® Art | üî¨ Science | üìö History | üßÆ Math | üíª Technology
                    </p>
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0;">
                        <p style="font-size: 16px; color: #333;">
                            <strong>üìã Quiz Rules:</strong><br>
                            ‚Ä¢ 10 Multiple Choice Questions<br>
                            ‚Ä¢ Select the correct option<br>
                            ‚Ä¢ Get instant feedback<br>
                            ‚Ä¢ Track your score in real-time
                        </p>
                    </div>
                </div>
            """)
            start_btn = gr.Button("üöÄ Start Quiz", size="lg", variant="primary", scale=2)
        
        
        with gr.Column(visible=False) as quiz_screen:
            progress_text = gr.Markdown("Question 1/10")
            category_text = gr.Markdown("üìÇ Category: General")
            question_text = gr.Markdown("### Question will appear here", elem_classes=["container"])
            
            with gr.Column():
                option_1 = gr.Button("A. Option 1", elem_classes=["option-btn"], variant="secondary")
                option_2 = gr.Button("B. Option 2", elem_classes=["option-btn"], variant="secondary")
                option_3 = gr.Button("C. Option 3", elem_classes=["option-btn"], variant="secondary")
                option_4 = gr.Button("D. Option 4", elem_classes=["option-btn"], variant="secondary")
            
            feedback_box = gr.HTML("")
            next_btn = gr.Button("‚û°Ô∏è Next Question", visible=False, variant="primary")
        
        
        with gr.Column(visible=False) as result_screen:
            result_display = gr.HTML("")
            restart_btn = gr.Button("üîÑ Restart Quiz", size="lg", variant="primary")
        
        
        start_btn.click(
            fn=frontend.start_quiz,
            outputs=[
                start_screen, quiz_screen, result_screen,
                question_text, option_1, option_2, option_3, option_4,
                feedback_box, progress_text, category_text,
                option_1, option_2, option_3, option_4, next_btn
            ]
        )
        
        
        option_1.click(
            fn=lambda: frontend.submit_answer(0),
            outputs=[feedback_box, option_1, option_2, option_3, option_4, next_btn]
        )
        
        option_2.click(
            fn=lambda: frontend.submit_answer(1),
            outputs=[feedback_box, option_1, option_2, option_3, option_4, next_btn]
        )
        
        option_3.click(
            fn=lambda: frontend.submit_answer(2),
            outputs=[feedback_box, option_1, option_2, option_3, option_4, next_btn]
        )
        
        option_4.click(
            fn=lambda: frontend.submit_answer(3),
            outputs=[feedback_box, option_1, option_2, option_3, option_4, next_btn]
        )
        
        
        next_btn.click(
            fn=frontend.load_next_question,
            outputs=[
                question_text, option_1, option_2, option_3, option_4,
                feedback_box, progress_text, category_text,
                option_1, option_2, option_3, option_4, next_btn
            ]
        )
        
        
        next_btn.click(
            fn=lambda: (gr.update(visible=False), gr.update(visible=True)) if backend.is_quiz_completed() else (gr.update(), gr.update()),
            outputs=[quiz_screen, result_screen]
        )
        
        
        restart_btn.click(
            fn=frontend.restart_quiz,
            outputs=[
                start_screen, quiz_screen, result_screen,
                question_text, option_1, option_2, option_3, option_4,
                feedback_box, progress_text, category_text,
                option_1, option_2, option_3, option_4, next_btn,
                result_display
            ]
        )
        
        
        gr.HTML("""
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px;">
                <h3 style="color: #667eea;">üìö System Architecture</h3>
                <p><strong>Backend Layer:</strong> Manages question bank, validates answers, calculates scores</p>
                <p><strong>Frontend Layer:</strong> Handles UI rendering, user interactions, displays feedback</p>
                <p><strong>Communication:</strong> Request-response pattern between layers</p>
            </div>
        """)
    
    return app



if __name__ == "__main__":
    print("=" * 60)
    print("üéØ QUIZ APPLICATION - MOBILE APP INTERNSHIP TASK 4")
    print("=" * 60)
    print("\nüìã System Architecture:")
    print("   ‚úì Backend Layer: Question management & validation")
    print("   ‚úì Frontend Layer: UI rendering & user interaction")
    print("   ‚úì Clear separation of concerns")
    print("\nüöÄ Launching Gradio Interface...")
    print("=" * 60)
    
    app = create_quiz_app()
    app.launch(debug=True, share=True)
